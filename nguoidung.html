<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Người Dùng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light p-4">

<div class="container bg-white p-4 rounded shadow">
    <h2 class="text-success text-center mb-4">QUẢN LÝ NGƯỜI DÙNG</h2>

    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" id="search" class="form-control" placeholder="Tìm theo tên, email, sdt...">
        </div>
        <div class="col-md-8 text-end">
            <button class="btn btn-success" id="btnAdd" data-bs-toggle="modal" data-bs-target="#modalNguoiDung">
                <i class="fas fa-user-plus"></i> Thêm Người Dùng
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-success">
                <tr>
                    <th>ID</th>
                    <th>Họ Tên</th>
                    <th>Email</th>
                    <th>SĐT</th>
                    <th>Địa Chỉ</th>
                    <th>Vai Trò</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalNguoiDung">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Thông tin người dùng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idND">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Họ Tên</label>
                        <input type="text" id="hoTen" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Mật Khẩu</label>
                        <input type="text" id="matKhau" class="form-control" placeholder="Nhập mật khẩu...">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Số Điện Thoại</label>
                        <input type="text" id="sdt" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Vai Trò</label>
                        <select id="vaiTro" class="form-select">
                            <option value="0">Khách hàng</option>
                            <option value="1">Admin (Quản trị)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Địa Chỉ</label>
                        <input type="text" id="diaChi" class="form-control">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" id="btnSave">Lưu Người Dùng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function () {
    loadNguoiDung();

    // 1. Tải danh sách
    function loadNguoiDung() {
        $.post("nguoidung_api.php", { action: "fetch" }, function (data) {
            let rows = "";
            $.each(JSON.parse(data), function (i, v) {
                // Xử lý hiển thị vai trò
                let roleText = v.VaiTro == 1 ? '<span class="badge bg-danger">Admin</span>' : '<span class="badge bg-secondary">Khách</span>';
                
                rows += `
                <tr>
                    <td>${v.MaNguoiDung}</td>
                    <td class="fw-bold">${v.HoTen}</td>
                    <td>${v.Email}</td>
                    <td>${v.SoDienThoai}</td>
                    <td>${v.DiaChi}</td>
                    <td>${roleText}</td>
                    <td>
                        <button class="btn btn-warning btn-sm btnEdit" data-json='${JSON.stringify(v)}'>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm btnDelete" data-id="${v.MaNguoiDung}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            $("#tableBody").html(rows);
        });
    }

    // 2. Nút Thêm mới
    $("#btnAdd").click(function(){
        $("#idND").val("");
        $("#hoTen").val("");
        $("#email").val("");
        $("#matKhau").val("");
        $("#sdt").val("");
        $("#diaChi").val("");
        $("#vaiTro").val("0"); // Mặc định là khách
    });

    // 3. Nút Lưu
    $("#btnSave").click(function () {
        let id = $("#idND").val();
        let action = id ? "update" : "insert";

        $.post("nguoidung_api.php", {
            action: action,
            id: id,
            hoten: $("#hoTen").val(),
            email: $("#email").val(),
            pass: $("#matKhau").val(),
            sdt: $("#sdt").val(),
            diachi: $("#diaChi").val(),
            vaitro: $("#vaiTro").val()
        }, function () {
            $("#modalNguoiDung").modal("hide");
            loadNguoiDung();
        });
    });

    // 4. Nút Sửa
    $(document).on("click", ".btnEdit", function () {
        let data = $(this).data("json");
        $("#idND").val(data.MaNguoiDung);
        $("#hoTen").val(data.HoTen);
        $("#email").val(data.Email);
        $("#matKhau").val(data.MatKhau);
        $("#sdt").val(data.SoDienThoai);
        $("#diaChi").val(data.DiaChi);
        $("#vaiTro").val(data.VaiTro);
        $("#modalNguoiDung").modal("show");
    });

    // 5. Nút Xóa
    $(document).on("click", ".btnDelete", function () {
        if(confirm("Xóa người dùng này?")) {
            $.post("nguoidung_api.php", { action: "delete", id: $(this).data("id") }, function(){
                loadNguoiDung();
            });
        }
    });

    // 6. Tìm kiếm
    $("#search").on("keyup", function () {
        let value = $(this).val().toLowerCase();
        $("#tableBody tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });
});
</script>

</body>
</html>