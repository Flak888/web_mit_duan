<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light p-4">

<div class="container-fluid bg-white p-4 rounded shadow">
    <h2 class="text-danger text-center mb-4">QUẢN LÝ ĐƠN HÀNG</h2>

    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" id="search" class="form-control" placeholder="Tìm mã đơn, tên khách...">
        </div>
        <div class="col-md-9 text-end">
            <button class="btn btn-danger" id="btnAdd" data-bs-toggle="modal" data-bs-target="#modalDonHang">
                <i class="fas fa-plus"></i> Tạo Đơn Mới
            </button>
        </div>
    </div>

    <table class="table table-bordered table-hover align-middle font-sm">
        <thead class="table-danger text-center">
            <tr>
                <th>Mã ĐH</th>
                <th>Khách Hàng</th>
                <th>Người Nhận</th>
                <th>Tổng Tiền</th>
                <th>Trạng Thái</th>
                <th>Ngày Đặt</th>
                <th>Thao Tác</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="modal fade" id="modalDonHang">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Thông tin đơn hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idDH">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Khách Hàng (Tài khoản đặt)</label>
                        <select id="maKH" class="form-select"></select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Trạng Thái</label>
                        <select id="trangThai" class="form-select fw-bold">
                            <option value="Mới đặt">Mới đặt</option>
                            <option value="Đang xác nhận">Đang xác nhận</option>
                            <option value="Đang giao hàng">Đang giao hàng</option>
                            <option value="Đã hoàn thành">Đã hoàn thành</option>
                            <option value="Đã hủy">Đã hủy</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Tên Người Nhận</label>
                        <input type="text" id="nguoiNhan" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>SĐT Nhận Hàng</label>
                        <input type="text" id="sdt" class="form-control">
                    </div>
                    <div class="col-md-12 mb-3">
                        <label>Địa Chỉ Giao</label>
                        <input type="text" id="diaChi" class="form-control">
                    </div>
                    <div class="col-md-12 mb-3">
                        <label>Tổng Tiền (VNĐ)</label>
                        <input type="number" id="tongTien" class="form-control fw-bold text-danger">
                        <small class="text-muted">* Tạm thời nhập tay, sau này sẽ tính tự động từ chi tiết đơn.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" id="btnSave">Lưu Đơn Hàng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function () {
    loadDonHang();
    loadKhachHang();

    // 1. Load danh sách Đơn hàng
    function loadDonHang() {
        $.post("donhang_api.php", { action: "fetch" }, function (data) {
            let rows = "";
            $.each(JSON.parse(data), function (i, v) {
                // Định dạng tiền
                let tien = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(v.TongTien);
                // Màu sắc trạng thái
                let badgeClass = 'bg-secondary';
                if(v.TrangThai === 'Đã hoàn thành') badgeClass = 'bg-success';
                if(v.TrangThai === 'Mới đặt') badgeClass = 'bg-primary';
                if(v.TrangThai === 'Đã hủy') badgeClass = 'bg-danger';

                rows += `
                <tr>
                    <td class="text-center fw-bold">#${v.MaDonHang}</td>
                    <td>
                        <span class="fw-bold text-primary">${v.HoTen || 'Khách lẻ'}</span><br>
                        <small class="text-muted">ID: ${v.MaNguoiDung}</small>
                    </td>
                    <td>
                        ${v.NguoiNhan}<br>
                        <small><i class="fas fa-phone"></i> ${v.SDT_Nhan}</small>
                    </td>
                    <td class="text-end fw-bold text-danger">${tien}</td>
                    <td class="text-center"><span class="badge ${badgeClass}">${v.TrangThai}</span></td>
                    <td class="text-center">${v.NgayDat}</td>
                    <td class="text-center">
                        <button class="btn btn-warning btn-sm btnEdit" data-json='${JSON.stringify(v)}'>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm btnDelete" data-id="${v.MaDonHang}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            $("#tableBody").html(rows);
        });
    }

    // 2. Load danh sách Khách hàng vào Select
    function loadKhachHang() {
        $.post("donhang_api.php", { action: "fetch_khachhang" }, function (data) {
            let options = "";
            $.each(JSON.parse(data), function (i, v) {
                options += `<option value="${v.MaNguoiDung}">${v.HoTen} (ID: ${v.MaNguoiDung})</option>`;
            });
            $("#maKH").html(options);
        });
    }

    // 3. Reset form khi thêm mới
    $("#btnAdd").click(function(){
        $("#idDH").val("");
        $("#maKH").prop('selectedIndex', 0);
        $("#nguoiNhan").val("");
        $("#sdt").val("");
        $("#diaChi").val("");
        $("#tongTien").val("0");
        $("#trangThai").val("Mới đặt");
    });

    // 4. Lưu dữ liệu
    $("#btnSave").click(function () {
        let id = $("#idDH").val();
        let action = id ? "update" : "insert";
        
        $.post("donhang_api.php", {
            action: action,
            id: id,
            maKH: $("#maKH").val(),
            nguoiNhan: $("#nguoiNhan").val(),
            sdt: $("#sdt").val(),
            diaChi: $("#diaChi").val(),
            tongTien: $("#tongTien").val(),
            trangThai: $("#trangThai").val()
        }, function () {
            $("#modalDonHang").modal("hide");
            loadDonHang();
        });
    });

    // 5. Đổ dữ liệu lên form để sửa
    $(document).on("click", ".btnEdit", function () {
        let data = $(this).data("json");
        $("#idDH").val(data.MaDonHang);
        $("#maKH").val(data.MaNguoiDung);
        $("#nguoiNhan").val(data.NguoiNhan);
        $("#sdt").val(data.SDT_Nhan);
        $("#diaChi").val(data.DiaChiGiao);
        $("#tongTien").val(data.TongTien);
        $("#trangThai").val(data.TrangThai);
        $("#modalDonHang").modal("show");
    });

    // 6. Xóa đơn hàng
    $(document).on("click", ".btnDelete", function () {
        if(confirm("Xóa đơn hàng này?")) {
            $.post("donhang_api.php", { action: "delete", id: $(this).data("id") }, function(){
                loadDonHang();
            });
        }
    });

    // 7. Tìm kiếm
    $("#search").on("keyup", function () {
        let value = $(this).val().toLowerCase();
        $("#tableBody tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });
});
</script>

</body>
</html>